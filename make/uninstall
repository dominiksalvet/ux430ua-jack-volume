#!/bin/sh

#-------------------------------------------------------------------------------
# Copyright 2018 Dominik Salvet
# SPDX-License-Identifier: MIT
# https://gitlab.com/dominiksalvet/ux430ua-jack-volume
#-------------------------------------------------------------------------------


#-------------------------------------------------------------------------------
# SOFTWARE DEPENDENCIES
#-------------------------------------------------------------------------------

# list of required software
SW_REQUIRED='command echo [ rm sed cd realpath head'

# check if some software is missing
for i in $SW_REQUIRED; do
    # software is missing if at least one piece of software is missing
    if ! command -v "$i" > /dev/null; then
        echo "$0: Required software '$i' is missing, uninstallation canceled." >&2
        exit 1
    fi
done

#-------------------------------------------------------------------------------
# DEFINITIONS
#-------------------------------------------------------------------------------

# configuration files directory
CONFIG_DIR=/etc/ux430ua-jack-volume-config

#-------------------------------------------------------------------------------
# CHECK STATE
#-------------------------------------------------------------------------------

# check if installed
if [ ! -f "$CONFIG_DIR/install-dir" ]; then
    echo "The uninstaller can't detect the program installed on this system, uninstallation canceled."
    exit 0
fi

# get the installation directory path (it can be relative)
INSTALLED_DIR="$(cd "$CONFIG_DIR/" && realpath -m "$(head -n 1 install-dir)")"
echo "The detected installation directory path is '$INSTALLED_DIR/'."

#-------------------------------------------------------------------------------
# UNINSTALLATION
#-------------------------------------------------------------------------------

# check if running as root
if [ "$(id -u)" -ne 0 ]; then
    echo "$0: Please run as root, uninstallation canceled." >&2
    exit 1
fi

# remove program's caller from systemd
rm /lib/systemd/system-sleep/ux430ua-jack-volume-caller
# remove all lines calling the program from '/etc/rc.local'
sed -i -E -e '/^[[:blank:]]*'"'.*\/ux430ua-jack-volume'"'(| .*)$/d' /etc/rc.local
sed -i -E -e '/^[[:blank:]]*([^[:blank:]]|\\ |\\	)*\/ux430ua-jack-volume(| .*)$/d' /etc/rc.local
# remove the program itself
rm "$INSTALLED_DIR/ux430ua-jack-volume"
# finish removing the program by deleting the 'install-dir' file
rm "$CONFIG_DIR/install-dir"

# final message
echo 'Uninstallation finished successfully! In order to apply the changes, reboot your device.'
